---
title: "不做“算命先生”：我在 AdTech 做了五年救火队员后的排查心法"
date: 2022-07-14T09:15:00+08:00
tags:
- troubleshooting
- adtech
- methodology
categories:
- adtech
- career
comment: true
featuredImagePreview: assets/cover-preview.jpg
---

> "能不能帮我看看为什么这个广告没出来？是不是系统挂了？"
>
> 刚入行做 AdTech 技术支持时，我最怕听到这种问题。那时候的我，像个蹩脚的算命先生，对着黑漆漆的屏幕这也是猜，那也是猜。"可能是配置错了？"、"可能是网络抖动？"、"可能是玄学？"。
>
> 这五年里，我处理过数千个工单，从一开始的手忙脚乱，到后来能像外科医生一样精准定位。我逐渐意识到，**故障排查（Troubleshooting）不是一种天赋，而是一门可以被系统化训练的工程学科。** 它有原则，有工具，更有套路。

![cover](assets/cover.jpg)

今天，我想把这套经过无数个深夜告警打磨出来的排查心法分享给你。它不仅适用于广告技术，也适用于任何复杂系统的除错。

## 一、 什么是排查？不是"试运气"，是"做减法"

很多人觉得排查就是漫无目的地翻日志，希望能撞大运看到一个 ERROR。

**大错特错。**

故障排查的本质，是一个**逻辑搜索与消除**的过程。它就像破案：
1.  **识别症状**：哪怕是"不工作"这三个字，也有无数种死法（是 404？是超时？还是返回了空数据？）。
2.  **消除法**：列出所有嫌疑人（网络、配置、代码、数据库），然后通过证据一个个排除。
3.  **最终确认**：只有当你能稳定复现问题，并能通过修复让它稳定消失时，排查才算结束。

## 二、 五大核心原则：别被"幸存者偏差"骗了

在处理复杂系统（比如日均百亿级请求的广告系统）时，这五条原则是我的保命符：

### 1. 始终了解"正常"行为 (Always Know Normal Behaviors)
这是排查的第一前提。如果你不知道一个健康的系统长什么样，你怎么知道它病了？
*   *例子*：你必须知道，正常的流量曲线在凌晨 3 点就是会跌底的。如果你不了解这个"正常"模式，可能会在大半夜因为"流量暴跌"而虚惊一场。

### 2. 只相信你亲眼所见 (Only Trust What You See)
**永远、永远不要轻信别人的描述。**
*   *客户说*："我通过了所有测试配置。"
*   *实际情况*：他不仅没通过，还把测试 ID 写反了。
*   *心法*：要日志，要截图，要 HAR 包。除了证据，谁都别信。

### 3. 任何行为都有原因 (Everything Has a Reason)
计算机不信鬼神。系统不会"突然"坏掉，一定有变量发生了改变。
*   *心法*：保持对细节的变态级敏感。那个不起眼的 Config Change，往往就是罪魁祸首。

### 4. 从数据中获取洞察 (Data Patterns)
在海量日志中，单独看一行 Log 是没用的。你要看的是**模式 (Pattern)**。
*   *例子*：是所有 iOS 用户都挂了？还是只有加利福尼亚的 iOS 用户挂了？通过维度的切分，你能瞬间把排查范围缩小 90%。

### 5. 区分原因与行为 (Causes vs Behaviors)
"CPU 飙升"是行为，不是原因。"死循环代码"才是原因。别把退烧药当成抗生素，治标不治本是排查大忌。

## 三、 武器库：主动、被动与场景

针对不同的战况，我们需要不同的武器：

| 战术类型 | 典型武器 | 适用场景 |
| :--- | :--- | :--- |
| **主动战术** (Proactive) | 在线调试器 (Debug Session)、测试预览页 | 甚至还没报警，但我总觉得哪里不对，主动去戳一下系统。 |
| **被动战术** (Passive) | 访问日志 (Access Logs)、聚合监控 (Datadog/Grafana) | 报警响了。这时候要冷静，先看大盘，再看个案。 |
| **场景战术** (Scenario) | 构造特定请求 (cURL)、复现脚本 | 既然你说有问题，那我就模拟一个一模一样的请求，看看到底会不会挂。 |

## 四、 实战案例：那些年踩过的坑

为了让你更有体感，我把这几年遇到的典型案例脱敏后分享几个。每一个坑，都是血泪的教训。

### 案例 1：消失的 25 天 (System Limits)
*   **现象**：某个频率控制（Frequency Capping）功能突然对长周期的设置失效了，比如"30天内只看1次"。
*   **真相**：我们的代码里把时间换算成秒。当周期超过 24.8 天时，秒数超过了整型 (Integer) 的上限，发生了**整数溢出**。
*   **教训**：了解系统的底层限制（数据库类型、变量类型）至关重要。

### 案例 2：掩耳盗铃的配置 (Config Error)
*   **现象**：运营同学火急火燎地跑来："我明明更新了定向规则，为什么没生效？这是 Bug！"
*   **真相**：在那个复杂的配置后台，有一个不起眼的小勾选框叫"应用到所有现有广告"。他改了规则，但没勾这个框。新规则只对新建广告生效，老广告依然我行我素。
*   **教训**：90% 的"系统 Bug"，最后查出来都是"配置失误"。

### 案例 3：时区的幽灵 (Environment)
*   **现象**：财务对账怎么都对不齐，总有几千块的差额。
*   **真相**：上游系统用的是 UTC 时间，我们用的是 EST 时间。每天跨天的那几个小时的数据，永远是个糊涂账。
*   **教训**：在跨国业务中，**Timezone** 是永远的头号嫌疑人。

## 结语

技术支持的进阶之路，就是从"瞎猜"到"逻辑推理"的进化。

当你下次再面对一个棘手的问题时，试着深呼吸，问自己三个问题：
1.  **正常的表现应该是什么？**
2.  **我现在看到的证据是什么？**
3.  **什么变量导致了这两者的差异？**

当你开始这样思考时，你就已经不再是算命先生，而是一名真正的工程师了。
